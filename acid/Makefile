.PHONY: help init-podman start-podman stop-podman status-podman build up down logs test-acid clean status db-connect

help:
	@echo "Comandos disponibles:"
	@echo "PODMAN:"
	@echo "make init-podman    - üöÄ Inicializar Podman (primera vez)"
	@echo "make start-podman   - ‚ñ∂Ô∏è Iniciar m√°quina Podman"
	@echo "make status-podman  - üîç Ver estado de Podman"
	@echo "make images         - üì∑ Ver todas las im√°genes"
	@echo "  make build      - Construir im√°genes Docker"
	@echo "  make up         - Levantar servicios"
	@echo "  make down       - Detener servicios"
	@echo "  make status     - Ver estado de servicios"
	@echo "  make db-connect - Conectar a MySQL (CLI)"

	@echo "  make logs       - Ver logs de los servicios"
	@echo "  make test-acid      - Ejecutar pruebas ACID"
	@echo "  make test-acid-sql  - Ejecutar pruebas ACID en MySQL"
	@echo "  make test-api       - Probar API"
	@echo "  make create-customer - Crear cliente"
	@echo "  make get-customer   - Obtener cliente"
	@echo "  make create-account - Crear cuenta"
	@echo "  make demo-mysql     - Demo ACID en MySQL"
	@echo "  make clean      - Limpiar contenedores y vol√∫menes"

init-podman:
	@echo "üöÄ Inicializando Podman..."
	podman machine init
	podman machine start
	@echo "‚úÖ Podman inicializado y iniciado"

start-podman:
	@echo "‚ñ∂Ô∏è Iniciando m√°quina Podman..."
	podman machine start
	@echo "‚úÖ M√°quina Podman iniciada"

stop-podman:
	@echo "‚èπÔ∏è Deteniendo m√°quina Podman..."
	podman machine stop
	@echo "‚úÖ M√°quina Podman detenida"

status-podman:
	@echo "üîç Estado de Podman:"
	podman machine list
	@echo ""
	@echo "Conexiones:"
	podman system connection list

build:
	@echo "üî® Iniciando Podman machine..."
	@podman machine start || true
	@echo "üî® Construyendo im√°genes con Podman..."
	~/.local/bin/podman-compose build

up:
	@echo "üöÄ Levantando servicios..."
	~/.local/bin/podman-compose up -d
	@echo "‚è≥ Esperando que los servicios est√©n listos..."
	@sleep 15
	@echo "‚úÖ Servicios listos!"
	@echo "üìç Spring Boot: http://localhost:8080"
	@echo "üìç MySQL: localhost:3306"

down:
	@echo "üõë Deteniendo servicios..."
	~/.local/bin/podman-compose down

logs:
	@echo "üìã Logs de los servicios..."
	~/.local/bin/podman-compose logs -f

test-acid:
	@echo "üß™ Ejecutando pruebas ACID desde Spring Boot..."
	@echo ""
	@echo "üìù EJECUCI√ìN 1: CREAR CLIENTE 1 (Elvin Gonz√°lez)"
	@curl -X POST http://localhost:8080/api/customer \
		-H "Content-Type: application/json" \
		-d '{"firstName":"Elvin","lastName":"Gonz√°lez","email":"elvin.gonzalez@email.com","phone":"555-0001"}' 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 2: CREAR CLIENTE 2 (Diego Ord√≥√±ez)"
	@curl -X POST http://localhost:8080/api/customer \
		-H "Content-Type: application/json" \
		-d '{"firstName":"Diego","lastName":"Ord√≥√±ez","email":"diego.ordonez@email.com","phone":"555-0002"}' 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 3: CREAR CUENTA PARA CLIENTE 1 ($$5000 CORRIENTE)"
	@curl -X POST http://localhost:8080/api/account \
		-H "Content-Type: application/json" \
		-d '{"customerId":1,"accountType":"CORRIENTE","initialBalance":5000}' 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 4: CREAR CUENTA PARA CLIENTE 2 ($$3000 AHORROS)"
	@curl -X POST http://localhost:8080/api/account \
		-H "Content-Type: application/json" \
		-d '{"customerId":2,"accountType":"AHORROS","initialBalance":3000}' 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 5: TRANSFERENCIA CLIENTE 1 A CLIENTE 2 ($$1000 - ACID)"
	@curl -X POST http://localhost:8080/api/transfer \
		-H "Content-Type: application/json" \
		-d '{"fromAccountId":1,"toAccountId":2,"amount":1000}' 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 6: VERIFICAR BALANCES FINALES"
	@echo "Cuenta 1 (Elvin):"
	@curl -X GET http://localhost:8080/api/account/1 2>/dev/null | jq .
	@echo "Cuenta 2 (Diego):"
	@curl -X GET http://localhost:8080/api/account/2 2>/dev/null | jq .
	@echo ""
	@echo "üìù EJECUCI√ìN 7: INTENTAR TRANSFERIR M√ÅS DINERO DEL DISPONIBLE (debe fallar)"
	@curl -X POST http://localhost:8080/api/transfer \
		-H "Content-Type: application/json" \
		-d '{"fromAccountId":1,"toAccountId":2,"amount":10000}' 2>/dev/null | jq .
	@echo ""
	@echo "‚úÖ Pruebas ACID desde Spring Boot completadas"

test-api:
	@echo "‚úÖ Probando API..."
	@curl -s http://localhost:8080/api/test | jq .

create-customer:
	@echo "üë§ Creando cliente..."
	@curl -X POST http://localhost:8080/api/customer \
		-H "Content-Type: application/json" \
		-d '{"firstName":"Juan","lastName":"Perez","email":"juan@test.com","phone":"123456789"}' | jq .

get-customer:
	@echo "üîç Obteniendo cliente ID 1..."
	@curl -X GET http://localhost:8080/api/customer/1 | jq .

create-account:
	@echo "üè¶ Creando cuenta para cliente ID 1..."
	@curl -X POST http://localhost:8080/api/account \
		-H "Content-Type: application/json" \
		-d '{"customerId":1,"accountType":"AHORROS","initialBalance":1000}' | jq .

demo-mysql:
	@echo "üíæ Demostraci√≥n ACID desde MySQL..."
	@echo "Conectando a MySQL para demostrar stored procedures..."
	@echo "Ejecuta: make db-connect"
	@echo "Luego ejecuta los siguientes comandos:"
	@echo "CALL sp_create_customer('Juan', 'Perez', 'juan@demo.com', '123456789', @id, @status, @msg);"
	@echo "SELECT @id, @status, @msg;"

status:
	@echo "üìä Estado de los servicios:"
	@podman ps --filter name=acid
	@echo ""
	@echo "üîç Verificando conexi√≥n a MySQL..."
	@podman exec acid-mysql mysqladmin -uroot -p123456 ping 2>/dev/null && echo "‚úÖ MySQL est√° funcionando" || echo "‚ùå MySQL no responde"
	@echo ""
	@echo "üìã Datos de conexi√≥n:"
	@echo "   Host: localhost"
	@echo "   Port: 3306"
	@echo "   Database: bankdb"
	@echo "   User: root"
	@echo "   Password: 123456"

db-connect:
	@echo "üîå Conectando a MySQL..."
	podman exec -it acid-mysql mysql -uroot -p123456 bankdb

test-acid-sql:
	@echo "üß™ Ejecutando pruebas ACID en MySQL..."
	@echo ""
	@echo "üìù Paso 1: Limpiar datos existentes"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "SET FOREIGN_KEY_CHECKS = 0; TRUNCATE TABLE transactions; TRUNCATE TABLE accounts; TRUNCATE TABLE customers; SET FOREIGN_KEY_CHECKS = 1;" 2>/dev/null
	@echo "‚úÖ Datos limpiados"
	@echo ""
	@echo "üìù EJECUCI√ìN 1: CREAR CLIENTE 1"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "CALL sp_create_customer('Elvin', 'Gonz√°lez', 'elvin.gonzalez@email.com', '555-0001', @cust_id1, @cust_status1, @cust_msg1); SELECT @cust_id1 AS customer_id, @cust_status1 AS estado, @cust_msg1 AS mensaje;"
	@echo ""
	@echo "üìù EJECUCI√ìN 2: CREAR CLIENTE 2"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "CALL sp_create_customer('Diego', 'Ord√≥√±ez', 'diego.ordonez@email.com', '555-0002', @cust_id2, @cust_status2, @cust_msg2); SELECT @cust_id2 AS customer_id, @cust_status2 AS estado, @cust_msg2 AS mensaje;"
	@echo ""
	@echo "üìù EJECUCI√ìN 3: CREAR CUENTA PARA CLIENTE 1"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "CALL sp_create_account(1, 'ACC-2024-001', 'CORRIENTE', 5000.00, @acc_id1, @acc_status1, @acc_msg1); SELECT @acc_id1 AS account_id, @acc_status1 AS estado, @acc_msg1 AS mensaje;"
	@echo ""
	@echo "üìù EJECUCI√ìN 4: CREAR CUENTA PARA CLIENTE 2"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "CALL sp_create_account(2, 'ACC-2024-002', 'AHORROS', 3000.00, @acc_id2, @acc_status2, @acc_msg2); SELECT @acc_id2 AS account_id, @acc_status2 AS estado, @acc_msg2 AS mensaje;"
	@echo ""
	@echo "üìù EJECUCI√ìN 5: TRANSFERENCIA CLIENTE 1 A CLIENTE 2 (ACID)"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "CALL sp_transfer_funds(1, 2, 1000.00, @tx_id, @tx_status, @tx_msg); SELECT @tx_id AS transaction_id, @tx_status AS estado, @tx_msg AS mensaje;"
	@echo ""
	@echo "üìù EJECUCI√ìN 6: VERIFICAR BALANCES FINALES"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "SELECT c.first_name, c.last_name, a.account_number, a.account_type, a.balance FROM customers c JOIN accounts a ON c.customer_id = a.customer_id ORDER BY c.customer_id;"
	@echo ""
	@echo "üìù EJECUCI√ìN 7: VER HISTORIAL DE TRANSACCIONES"
	@podman exec acid-mysql mysql -uroot -p123456 bankdb -e "SELECT t.transaction_id, t.transaction_type, fa.account_number AS cuenta_origen, ta.account_number AS cuenta_destino, t.amount, t.status, t.created_at FROM transactions t LEFT JOIN accounts fa ON t.from_account_id = fa.account_id LEFT JOIN accounts ta ON t.to_account_id = ta.account_id ORDER BY t.created_at DESC;"
	@echo ""
	@echo "‚úÖ Pruebas ACID en MySQL completadas"

clean:
	@echo "üßπ Limpiando contenedores y vol√∫menes..."
	~/.local/bin/podman-compose down -v
	@echo "‚úÖ Limpieza completada"
