# Makefile para Optimizaci√≥n de Im√°genes Docker
DOCKER_USER = 
DOCKER_PASS = 
IMAGE_NAME = demo-springboot
TAG_BAD = bad
TAG_OPTIMIZED = optimized
TAG_V1 = v1.0.0
TAG_V2 = v2.0.0
APP_DIR_V1 = springboot-app
APP_DIR_V2 = springboot-app-v2

.PHONY: help init-podman start-podman stop-podman status-podman images build-bad run-bad dive-bad build-optimized run-optimized dive-optimized build-v1 build-v2 run-v1 run-v2 workflow-v1 workflow-v2 compare login push-v1 push-v2 clean details stop-all test-endpoints remove-image clean-none

help:
	@echo "Optimizaci√≥n de Im√°genes Docker"
	@echo "============================================="
	@echo "INICIALES:"
	@echo "make init-podman    - üöÄ Inicializar Podman (primera vez)"
	@echo "make start-podman   - ‚ñ∂Ô∏è Iniciar m√°quina Podman"
	@echo "make status-podman  - üîç Ver estado de Podman"
	@echo "make images         - üì∑ Ver todas las im√°genes"
	@echo ""
	@echo "IMAGEN MAL OPTIMIZADA (BAD):"
	@echo "make build-bad      - Construir imagen mal optimizada"
	@echo "make run-bad        - Ejecutar contenedor mal optimizado"
	@echo "make dive-bad       - Analizar imagen mal optimizada con dive"
	@echo ""
	@echo "IMAGEN OPTIMIZADA:"
	@echo "make build-optimized - Construir imagen optimizada"
	@echo "make run-optimized  - Ejecutar contenedor optimizado"
	@echo "make dive-optimized - Analizar imagen optimizada con dive"
	@echo ""
	@echo "FLUJOS COMPLETOS (VERSIONES):"
	@echo "make build-v1       - Construir imagen v1.0.0"
	@echo "make run-v1         - Ejecutar contenedor v1.0.0"
	@echo "make workflow-v1    - üöÄ Flujo completo v1.0.0 (build + run + push)"
	@echo "make build-v2       - Construir imagen v2.0.0"
	@echo "make run-v2         - Ejecutar contenedor v2.0.0"
	@echo "make workflow-v2    - üöÄ Flujo completo v2.0.0 (build + run + push)"
	@echo "make push-v1        - Subir imagen v1.0.0 a Docker Hub"
	@echo "make push-v2        - Subir imagen v2.0.0 a Docker Hub"
	@echo ""
	@echo "GESTI√ìN:"
	@echo "make compare        - Comparar tama√±os de im√°genes"
	@echo "make details        - Ver detalles de las im√°genes"
	@echo "make stop-all       - Detener todos los contenedores"
	@echo "make clean          - Limpiar im√°genes locales"
	@echo "make clean-none     - Eliminar todas las im√°genes <none>"
	@echo "make remove-image   - Eliminar imagen espec√≠fica (solicita nombre)"
	@echo "make test-endpoints - Probar endpoints de la aplicaci√≥n"
	@echo "make stop-podman    - ‚èπÔ∏è Detener m√°quina Podman"
	@echo ""
	@echo "üìù Antes de usar, cambiar DOCKER_USER por tu usuario real"

# ============================================
# COMANDOS INICIALES
# ============================================

init-podman:
	@echo "üöÄ Inicializando Podman..."
	podman machine init
	podman machine start
	@echo "‚úÖ Podman inicializado y iniciado"

start-podman:
	@echo "‚ñ∂Ô∏è Iniciando m√°quina Podman..."
	podman machine start
	@echo "‚úÖ M√°quina Podman iniciada"

stop-podman:
	@echo "‚èπÔ∏è Deteniendo m√°quina Podman..."
	podman machine stop
	@echo "‚úÖ M√°quina Podman detenida"

status-podman:
	@echo "üîç Estado de Podman:"
	podman machine list
	@echo ""
	@echo "Conexiones:"
	podman system connection list

images:
	@echo "üìã TODAS LAS IM√ÅGENES:"
	@echo "====================="
	podman images

# ============================================
# IMAGEN MAL OPTIMIZADA (BAD)
# ============================================

build-bad:
	@echo "üöÄ Construyendo imagen MAL OPTIMIZADA..."
	@echo "Dockerfile: dockerfiles/Dockerfile.bad"
	podman build -f dockerfiles/Dockerfile.bad -t $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD) $(APP_DIR_V1)
	@echo "‚úÖ Imagen mal optimizada creada: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD)"

run-bad: build-bad stop-bad
	@echo "üöÄ Ejecutando contenedor mal optimizado..."
	podman run -d --name demo-bad -p 8080:8080 $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD)
	@echo "‚úÖ Contenedor iniciado en http://localhost:8080"

stop-bad:
	@echo "üõë Deteniendo contenedor mal optimizado..."
	podman stop demo-bad 2>/dev/null || true
	podman rm demo-bad 2>/dev/null || true

dive-bad:
	@echo "üîç Analizando imagen mal optimizada con dive (interactivo)..."
	dive --source podman $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD)

# ============================================
# IMAGEN OPTIMIZADA
# ============================================

build-optimized:
	@echo "üöÄ Construyendo imagen OPTIMIZADA..."
	@echo "Dockerfile: dockerfiles/Dockerfile.optimized"
	podman build -f dockerfiles/Dockerfile.optimized -t $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED) $(APP_DIR_V1)
	@echo "‚úÖ Imagen optimizada creada: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED)"

run-optimized: build-optimized stop-optimized
	@echo "üöÄ Ejecutando contenedor optimizado..."
	podman run -d --name demo-optimized -p 8081:8080 $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED)
	@echo "‚úÖ Contenedor iniciado en http://localhost:8081"

stop-optimized:
	@echo "üõë Deteniendo contenedor optimizado..."
	podman stop demo-optimized 2>/dev/null || true
	podman rm demo-optimized 2>/dev/null || true

dive-optimized:
	@echo "üîç Analizando imagen optimizada con dive (interactivo)..."
	dive --source podman $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED)

# ============================================
# FLUJOS COMPLETOS (VERSIONES)
# ============================================

build-v1:
	@echo "üöÄ Construyendo imagen v1.0.0..."
	@echo "Dockerfile: dockerfiles/Dockerfile.optimized"
	podman build -f dockerfiles/Dockerfile.optimized -t $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1) $(APP_DIR_V1)
	@echo "‚úÖ Imagen v1.0.0 creada: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1)"

run-v1: build-v1
	@echo "üöÄ Ejecutando contenedor v1.0.0..."
	podman stop demo-v1 2>/dev/null || true
	podman rm demo-v1 2>/dev/null || true
	podman run -d --name demo-v1 -p 8082:8080 $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1)
	@echo "‚úÖ Contenedor v1.0.0 iniciado en http://localhost:8082"

workflow-v1: build-v1 run-v1 push-v1
	@echo "‚úÖ üéâ Workflow v1.0.0 completado exitosamente!"
	@echo "Contenedor: http://localhost:8082"
	@echo "Imagen: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1)"

push-v1: login
	@echo "üì§ Subiendo imagen v1.0.0 a Docker Hub..."
	podman push $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1)
	@echo "‚úÖ Imagen v1.0.0 subida: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V1)"

build-v2:
	@echo "üöÄ Construyendo imagen v2.0.0..."
	@echo "Dockerfile: dockerfiles/Dockerfile.v2"
	podman build -f dockerfiles/Dockerfile.v2 -t $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2) $(APP_DIR_V2)
	@echo "‚úÖ Imagen v2.0.0 creada: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2)"

run-v2: build-v2
	@echo "üöÄ Ejecutando contenedor v2.0.0..."
	podman stop demo-v2 2>/dev/null || true
	podman rm demo-v2 2>/dev/null || true
	podman run -d --name demo-v2 -p 8083:8080 $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2)
	@echo "‚úÖ Contenedor v2.0.0 iniciado en http://localhost:8083"

workflow-v2: build-v2 run-v2 push-v2
	@echo "‚úÖ üéâ Workflow v2.0.0 completado exitosamente!"
	@echo "Contenedor: http://localhost:8083"
	@echo "Imagen: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2)"

push-v2: login
	@echo "üì§ Subiendo imagen v2.0.0 a Docker Hub..."
	podman push $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2)
	@echo "‚úÖ Imagen v2.0.0 subida: $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_V2)"

# ============================================
# COMANDOS DE GESTI√ìN
# ============================================

login:
	@echo "üîë Haciendo login en Docker Hub..."
	@echo "$(DOCKER_PASS)" | podman login docker.io -u $(DOCKER_USER) --password-stdin
	@echo "‚úÖ Login completado"

compare:
	@echo "üìä COMPARACI√ìN DE TAMA√ëOS:"
	@echo "=========================="
	@echo "‚ùå Imagen mal optimizada:"
	podman images $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD) --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
	@echo "‚úÖ Imagen optimizada:"
	podman images $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED) --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
	@echo ""
	@echo "üîç Para analizar con dive:"
	@echo "dive $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD)"
	@echo "dive $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED)"

details:
	@echo "üîç DETALLES DE LAS IM√ÅGENES:"
	@echo "============================"
	@echo "‚ùå Imagen mal optimizada:"
	podman inspect $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD) --format '{{.Size}} bytes, {{len .RootFS.Layers}} layers' 2>/dev/null || echo "Imagen no encontrada"
	@echo "‚úÖ Imagen optimizada:"
	podman inspect $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED) --format '{{.Size}} bytes, {{len .RootFS.Layers}} layers' 2>/dev/null || echo "Imagen no encontrada"

stop-all:
	@echo "üõë Deteniendo todos los contenedores..."
	podman stop demo-bad demo-optimized demo-v1 demo-v2 2>/dev/null || true
	podman rm demo-bad demo-optimized demo-v1 demo-v2 2>/dev/null || true
	@echo "‚úÖ Todos los contenedores detenidos"

clean:
	@echo "üßπ Limpiando im√°genes locales..."
	podman rmi $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_BAD) 2>/dev/null || true
	podman rmi $(DOCKER_USER)/$(IMAGE_NAME):$(TAG_OPTIMIZED) 2>/dev/null || true

test-endpoints:
	@echo "üß™ Probando endpoints de la aplicaci√≥n..."
	@echo "üìç GET /"
	curl -s http://localhost:8081/
	@echo ""
	@echo "üìç GET /hello"
	curl -s http://localhost:8081/health
	@echo ""
	@echo "üìç GET /actuator/health"
	curl -s http://localhost:8081/info

remove-image:
	@echo "üóëÔ∏è ELIMINAR IMAGEN ESPEC√çFICA"
	@echo "=============================="
	@echo "Im√°genes disponibles:"
	@podman images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
	@echo ""
	@read -p "Ingresa el nombre de la imagen a eliminar (formato: repository:tag): " IMAGE_TO_REMOVE; \
	if [ -n "$$IMAGE_TO_REMOVE" ]; then \
		echo "Eliminando imagen: $$IMAGE_TO_REMOVE"; \
		podman rmi "$$IMAGE_TO_REMOVE" || echo "‚ùå Error al eliminar la imagen"; \
	else \
		echo "‚ùå No se proporcion√≥ nombre de imagen"; \
	fi

clean-none:
	@echo "üßπ Eliminando im√°genes <none>..."
	@NONE_IMAGES=$$(podman images -f "dangling=true" -q); \
	if [ -n "$$NONE_IMAGES" ]; then \
		echo "Eliminando $$(echo "$$NONE_IMAGES" | wc -l) im√°genes sin etiqueta..."; \
		echo "$$NONE_IMAGES" | xargs podman rmi; \
		echo "‚úÖ Im√°genes <none> eliminadas"; \
	else \
		echo "‚úÖ No hay im√°genes <none> para eliminar"; \
	fi